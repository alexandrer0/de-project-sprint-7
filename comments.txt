Регистрации рассчитал по первым сообщениям.
Повторяющиеся преобразования вынес в отдельную функцию.
Насчет предположения, что если пользователи в разных городах, то расстояние между ними больше 1 км - идею понял,
    буду иметь ввиду, хотя это не совсем соответствует условиям задачи. Если не критично, исправлять не буду.

Вопросов нет.